FROM --platform=linux/amd64 lucee/lucee:5.3.8.88-SNAPSHOT

# Install curl for healthcheck
RUN apt-get update && apt-get install -y \
    curl \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create a simple index.cfm file directly in /var/www
RUN echo '<cfoutput><h1>Lucee is running! Will be shipping cool stuff soon.</h1><p>Server time: #now()#</p><p></p></cfoutput>' > /var/www/index.cfm

# Create password file for Lucee and ensure admin is enabled
RUN mkdir -p /opt/lucee/server/lucee-server/context/ && \
    mkdir -p /usr/local/tomcat/webapps/ROOT/WEB-INF/lucee/

# Fix the Tomcat port to match our docker-compose configuration
RUN sed -i 's/port="8888"/port="8080"/g' /usr/local/tomcat/conf/server.xml

# Expose ports
EXPOSE 8080

# Copy entrypoint script
COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Set the entrypoint and CMD
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
CMD ["catalina.sh", "run"] 